<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="dsfd"><title>mysql的一些细节 | 雨天</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">mysql的一些细节</h1><a id="logo" href="/.">雨天</a><p class="description">行百里者半九十</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">mysql的一些细节</h1><div class="post-meta">May 6, 2017<span> | </span><span class="category"><a href="/categories/mysql/">mysql</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><h2 id="范式和反范式"><a href="#范式和反范式" class="headerlink" title="范式和反范式"></a>范式和反范式</h2><p>范式在有些本科的教材中将的其实挺晦涩的，比如《数据库系统概论》，后来在知乎上看到一个很好的答案： <a href="https://www.zhihu.com/question/24696366/answer/29189700" target="_blank" rel="external">关于范式</a></p>
<p>在最理想的范式化的数据库中，每个数据只会出现一次，而在反范式化的数据库中，信息是冗余的，可能会存在许多的地方。</p>
<p>举个经典的例子，一个包含雇员，部门，部门领导的表：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">EMPLOYEE | DEPARTMENT  | HEAD</div><div class="line">---------|-------------|-----</div><div class="line">Jones    | Accounting  | Jones</div><div class="line">Smith    | Engineering | Smith</div><div class="line">Brown    | Accounting  | Jones</div><div class="line">Green    | Engineering | Smith</div></pre></td></tr></table></figure>
<p>这个表主要的问题就是修改数据时可能会发生不一致，需要修改多处数据。比如更换<code>Accounting</code>部门领导的时候，就需要修改多行数据。比较麻烦。</p>
<p>所以可以对这个表进行范式化，将表分为雇员表和部门表来进行存储：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">雇员表</div><div class="line">EMPLOYEE | DEPARTMENT  </div><div class="line">---------|-------------</div><div class="line">Jones    | Accounting  </div><div class="line">Smith    | Engineering</div><div class="line">Brown    | Accounting  </div><div class="line">Green    | Engineering</div><div class="line"></div><div class="line">部门表</div><div class="line">DEPARTMENT  | HEAD</div><div class="line">------------|-----</div><div class="line">Accounting  | Jones</div><div class="line">Engineering | Smith</div></pre></td></tr></table></figure>
<p>这样设计的表就符合第二范式了，针对上一个问题，就可以很简单的解决了，修改部门表即可。</p>
<h3 id="范式的优点和缺点"><a href="#范式的优点和缺点" class="headerlink" title="范式的优点和缺点"></a>范式的优点和缺点</h3><p>范式化的数据库在写密集型的场景，是很好的，因为：</p>
<ol>
<li>范式化的更新操作通常比反范式化要快</li>
<li>当数据较好地范式化时，就只有很少或者没有重复数据，所以只需要修改很少的数据。</li>
<li>范式化的表通常更小，可以更好的放在内存里，所以执行操作会更快</li>
<li>检索列表数据时更少需要<code>DISTINCT</code>或者<code>GROUP BY</code>语句</li>
</ol>
<p>但是范式化设计的schema的缺点就是通常需要关联，而关联的代价昂贵，也可能使一些索引策略失效。比如多列索引，如果数据都放在一个表中，是可以使用多列索引来解决的。</p>
<h3 id="反范式化的优点和缺点"><a href="#反范式化的优点和缺点" class="headerlink" title="反范式化的优点和缺点"></a>反范式化的优点和缺点</h3><p>反范式化的schema因为所有数据都在一张表中，可以很好地避免关联。</p>
<p>如果不需要关联表，就算对于没有使用索引的查询情况，全表扫描也可能比关联要快的多，因为避免了很多随机IO。(一般全表扫描都是顺序IO)。</p>
<h3 id="混用范式化和反范式化"><a href="#混用范式化和反范式化" class="headerlink" title="混用范式化和反范式化"></a>混用范式化和反范式化</h3><p>在真实的业务场景中，很少会有完全的范式化和完全反范式化的schema。都是根据具体的查询场景来冗余一部分列到需要查询的表中，这样就可以优化查询的性能。</p>
<h2 id="InnoDB中的多列索引"><a href="#InnoDB中的多列索引" class="headerlink" title="InnoDB中的多列索引"></a>InnoDB中的多列索引</h2><p>对于单列索引，在介绍索引的时候已经说过。现在说说多列索引的实现。</p>
<p>假如有如下数据表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> People (</div><div class="line">  last_name   <span class="built_in">varchar</span>(<span class="number">50</span>)   <span class="keyword">not</span> <span class="literal">null</span>,</div><div class="line">  first_name  <span class="built_in">varchar</span>(<span class="number">50</span>)   <span class="keyword">not</span> <span class="literal">null</span>,</div><div class="line">  dob         <span class="built_in">date</span>          <span class="keyword">not</span> <span class="literal">null</span>,</div><div class="line">  gender      enum(<span class="string">'m'</span>, <span class="string">'f'</span>)<span class="keyword">not</span> <span class="literal">null</span>,</div><div class="line">  <span class="keyword">key</span>(last_name, first_name, dob)</div><div class="line">);</div></pre></td></tr></table></figure>
<p>那么索引的数据存储结构如下：<br><img src="/img/multi_index.jpg" alt="多列索引"></p>
<p>可以看到，在索引的非叶子节点中，都存有索引的每一列的值，而且都是有序的（对于前缀列都一致的情况）。</p>
<p>在使用多列索引进行查找时的一些查询方式如下：</p>
<ol>
<li><p>全值匹配<br>全值匹配指的是和索引中的所有的列进行匹配。比如查找姓名为Cuba Allen,生于1960-01-01的人。</p>
</li>
<li><p>匹配最左前缀<br>对于前面索引，可以只使用索引的某一些列，比如只按照姓名来查找。<br>最左前缀匹配应该是大家都很熟悉的。对于多列索引，在使用的时候有些地方还是需要注意。</p>
<ul>
<li>要想使用索引，只能从索引的最左列开始查找，否则无法使用索引。比如不能用索引查找名字为Allen的人，也无法查找某个特定生日的人。</li>
<li>同时也不能跳过索引中的列。也就是无法用于查找姓为Cuba，并且生日为某一个特定日期的人，如果不指定名，那么只能使用索引的第一列。</li>
<li>如果查询中有某个列的范围查询，则其右边的所有列都无法使用索引优化查找。比如<code>WHERE last_name=&#39;Smith&#39; AND first_name LIKE &#39;J%&#39; AND dob=&#39;1976-12-23&#39;</code>.这个查询只能使用索引的前两列，因为<code>LIKE</code>是一个范围条件。<br>所以索引列的顺序是很重要的，在设计索引的时候，需要考虑到以后可能得查询的方式。</li>
</ul>
</li>
<li><p>匹配列前缀<br>可以职匹配某一列的的值的开头部分，比如查找所有以<code>J</code>开头的姓的人。</p>
</li>
<li><p>精确匹配某一列并范围匹配另外一列<br>比如查找所有姓为Allen，并且名为<code>K</code>开头的人。</p>
</li>
<li><p>只访问索引的查询<br>B-tree支持只访问索引，不访问数据行的查询。比如覆盖索引。</p>
</li>
</ol>
<h2 id="关联查询的执行方式"><a href="#关联查询的执行方式" class="headerlink" title="关联查询的执行方式"></a>关联查询的执行方式</h2><p>很多时候，大家都会说不要使用关联查询，这样性能不好。这里说一下关联查询的执行方式。</p>
<p>比如说<code>UNION</code>查询，Mysql先将一系列的单个查询结果放到一个临时表中，然后在重新读取出临时表的数据来完成<code>UNION</code>的查询。</p>
<p>对于多表的关联查询，当前Mysql的关联查询的策略也很简单：对于任何关联都执行嵌套循环关联操作，即Mysql会现在一个表中循环取出单条数据，然后再嵌套循环到下一个表中寻找匹配的行，依次下去，直到找到所有表中匹配的行为止。然后根据各个表匹配的行，返回查询中需要的各个列。</p>
<p>举个例子，有一个简单查询：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> tbl1.col1, tbl2.col2</div><div class="line">  <span class="keyword">FROM</span> tbl1</div><div class="line">  <span class="keyword">INNER</span> <span class="keyword">JOIN</span> tbl2 <span class="keyword">USING</span>(col3)</div><div class="line">  <span class="keyword">WHERE</span> tbl1.col1 <span class="keyword">IN</span>(<span class="number">5</span>,<span class="number">6</span>);</div></pre></td></tr></table></figure></p>
<p>那么按照前面说的嵌套循环的关联操作，可以用下面的伪代码来表示Mysql将如何完成这个查询：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">outer_iter = iterator over tbl1 where col1 IN(5,6)</div><div class="line">outer_row = outer_iter.next</div><div class="line">while outer_row</div><div class="line">    inner_iter = iterator over tbl2 where col3 = outer_row.col3 inner_row = inner_iter.next</div><div class="line">    while inner_row</div><div class="line">        output [ outer_row.col1, inner_row.col2 ]</div><div class="line">        inner_row = inner_iter.next</div><div class="line">        end</div><div class="line">    outer_row = outer_iter.next</div><div class="line">end</div></pre></td></tr></table></figure></p>
<p>对于外连接的查询，比如：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> tbl1.col1, tbl2.col2</div><div class="line">  <span class="keyword">FROM</span> tbl1</div><div class="line">  <span class="keyword">LEFT</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> tbl2 <span class="keyword">USING</span>(col3)</div><div class="line">  <span class="keyword">WHERE</span> tbl1.col1 <span class="keyword">IN</span>(<span class="number">5</span>,<span class="number">6</span>);</div></pre></td></tr></table></figure></p>
<p>对应的伪代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">outer_iter = iterator over tbl1 where col1 IN(5,6)</div><div class="line">outer_row = outer_iter.next</div><div class="line">while outer_row</div><div class="line">    inner_iter = iterator over tbl2 where col3 = outer_row.col3 inner_row = inner_iter.next</div><div class="line">    if inner_row</div><div class="line">        while inner_row</div><div class="line">            output [ outer_row.col1, inner_row.col2 ]</div><div class="line">            inner_row = inner_iter.next end</div><div class="line">    else</div><div class="line">        output [ outer_row.col1, NULL ]</div><div class="line">    end</div><div class="line">    outer_row = outer_iter.next</div><div class="line">end</div></pre></td></tr></table></figure></p>
<p>主要区别在于左外连接，如过第二张表中没有数据，需要把相应的列补<code>NULL</code>。当然，碰到右外连接时，mysql会将右外连接改为等价的左外连接。</p>
<p>另一种可视化查询执行计划的方法就是根据优化器执行的路径绘制出对应的泳道图(swim-lane diagram)，如下图所示：<br><img src="/img/swim-lane-diagram.jpg" alt="泳道图"></p>
<p>对于多表关联的查询，mysql的执行计划如下图所示，是一颗左侧深度优先的树：<br><img src="/img/mysql_multi_tables.jpg" alt="多表关联"></p>
<p>从上面这些信息可以看出，这就是为什么关联查询会影响性能的原因，也是为什么大家常说要使用小表驱动大表的原因，因为小表驱动达标会减少外层循环的数目。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://yoursite.com/2017/05/06/2017-05-06-mysql/" data-id="cj4e505co007u6xacdjwpjkx7" class="article-share-link">分享</a><div class="tags"></div><div class="post-nav"><a href="/2017/05/06/2017-05-06-linux-awk/" class="pre">awk</a><a href="/2017/05/01/2017-05-01-nsq/" class="next">NSQD源码分析</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/JAVA/">JAVA</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/LeetCode/">LeetCode</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/NSQ/">NSQ</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/algorithms/">algorithms</a><span class="category-list-count">32</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/cpp/">cpp</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/database/">database</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/go/">go</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/golang/">golang</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/lintcode/">lintcode</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/problems/">problems</a><span class="category-list-count">22</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/其他/">其他</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/操作系统/">操作系统</a><span class="category-list-count">2</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Hash-Table/" style="font-size: 15px;">Hash Table</a> <a href="/tags/动态规划/" style="font-size: 15px;">动态规划</a> <a href="/tags/图/" style="font-size: 15px;">图</a> <a href="/tags/二分搜索/" style="font-size: 15px;">二分搜索</a> <a href="/tags/Tree/" style="font-size: 15px;">Tree</a> <a href="/tags/Math/" style="font-size: 15px;">Math</a> <a href="/tags/Linked-List/" style="font-size: 15px;">Linked List</a> <a href="/tags/二叉树/" style="font-size: 15px;">二叉树</a> <a href="/tags/Stack/" style="font-size: 15px;">Stack</a> <a href="/tags/Array/" style="font-size: 15px;">Array</a> <a href="/tags/Bit-Manipulation/" style="font-size: 15px;">Bit Manipulation</a> <a href="/tags/Deque/" style="font-size: 15px;">Deque</a> <a href="/tags/Two-Pointers/" style="font-size: 15px;">Two Pointers</a> <a href="/tags/设计模式/" style="font-size: 15px;">设计模式</a> <a href="/tags/SkipList/" style="font-size: 15px;">SkipList</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/10/07/2017-10-07-docker-ethereum/">基于Docker的Ethereum 开发环境搭建</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/27/2017-06-26-go-profile/">go 基准测试和pprof的使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/26/2017-06-26-go-malloc/">go内存分配</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/19/2017-06-19-ratelimiter/">Ratelimter</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/03/2017-06-03-vm/">虚拟存储器</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/06/2017-05-06-linux-awk/">awk</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/06/2017-05-06-mysql/">mysql的一些细节</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/01/2017-05-01-nsq/">NSQD源码分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/25/2016-03-25-skip-list/">SkipList(跳表)</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/22/2016-03-22-stack-problems/">栈的一些巧妙应用</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://1mhz.me" title="1mhz" target="_blank">1mhz</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">雨天.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
  });
</script><script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML" async></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>